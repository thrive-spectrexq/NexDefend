name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
    tags: [ 'v*' ] # Trigger workflow on version tags (e.g., v1.0.0)
    paths-ignore:
      - 'docs/**'
      - '**.md'
  pull_request:
    branches: [ "main" ]
    paths-ignore:
      - 'docs/**'
      - '**.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write # Required to create Releases
  packages: write
  security-events: write

jobs:
  # ============================================================================
  # 1. CORE API (Go)
  # ============================================================================
  test-api:
    name: API (Go)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          cache: true

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y librdkafka-dev

      - name: Lint (golangci-lint)
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m

      - name: Test
        run: CGO_ENABLED=1 go test -tags musl -race -v ./...

  # ============================================================================
  # 2. AI SERVICE (Python)
  # ============================================================================
  test-ai:
    name: AI (Python)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nexdefend-ai
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          sudo apt-get install -y nmap
          pip install -r requirements.txt
          pip install pytest flake8

      - name: Lint
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Test
        run: pytest

  # ============================================================================
  # 3. FRONTEND (React)
  # ============================================================================
  test-frontend:
    name: Frontend (React)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./nexdefend-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: nexdefend-frontend/package-lock.json

      - name: Install Dependencies
        run: npm ci

      - name: Type Check
        run: npm run type-check

      - name: Build
        run: npm run build

  # ============================================================================
  # 4. MICROSERVICES
  # ============================================================================
  test-microservices:
    name: Service ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [nexdefend-soar, nexdefend-agent, nexdefend-cloud-connector]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          cache: true

      - name: Install System Deps
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev librdkafka-dev

      - name: Test ${{ matrix.service }}
        working-directory: ./${{ matrix.service }}
        run: CGO_ENABLED=1 go test -tags "libkafka musl" -v ./...

  # ============================================================================
  # 5. DESKTOP APP (Windows Build) -- NEW
  # ============================================================================
  build-desktop:
    name: Desktop App (Windows)
    runs-on: windows-latest
    needs: [test-api, test-frontend] # Wait for tests to pass
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24.3'
          # Cache based on the desktop module
          cache-dependency-path: nexdefend-desktop/go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          # Wails builds the frontend located here
          cache-dependency-path: nexdefend-frontend/package-lock.json

      # Match Wails version from go.mod (v2.8.0)
      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@v2.8.0

      - name: Build Windows App
        working-directory: ./nexdefend-desktop
        # Builds using wails.json config, targeting Windows
        run: |
          wails build -platform windows/amd64 -clean

      # Uploads the .exe so you can download it from the "Actions" tab in GitHub
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: nexdefend-desktop-windows
          path: nexdefend-desktop/build/bin/nexdefend-desktop.exe
          if-no-files-found: error

      # Automatically creates a Release if a tag (e.g., v1.0.0) was pushed
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: nexdefend-desktop/build/bin/nexdefend-desktop.exe
          draft: false
          prerelease: false

  # ============================================================================
  # 6. DOCKER BUILD & SECURITY SCAN
  # ============================================================================
  build-images:
    name: Docker Build & Scan
    needs: [test-api, test-ai, test-frontend, test-microservices]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - service: api
            context: .
            dockerfile: Dockerfile
          - service: ai
            context: nexdefend-ai
            dockerfile: nexdefend-ai/Dockerfile
          - service: soar
            context: nexdefend-soar
            dockerfile: nexdefend-soar/Dockerfile
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and Export
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          load: true
          tags: nexdefend/${{ matrix.service }}:test
      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'nexdefend/${{ matrix.service }}:test'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
