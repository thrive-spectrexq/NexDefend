version: '3.8'

services:
  # --- 1. Core API Service ---
  api:
    image: nexdefend/core:v1.0.0
    container_name: nexdefend-api
    restart: always
    # OVERRIDE: Run only the Go binary, not the full start.sh script
    command: /nexdefend
    environment:
      - DB_TYPE=postgres             # Triggers Enterprise DB Mode
      - DB_HOST=postgres
      - DB_USER=nexdefend
      - DB_PASSWORD=secure_password
      - DB_NAME=nexdefend
      - KAFKA_BROKER=kafka:9092      # Triggers Enterprise Kafka Mode
      - OPENSEARCH_ADDR=http://opensearch:9200
      - PYTHON_API=http://ai:5000    # Points to separate AI container
      - SOAR_URL=http://soar:8000    # Points to separate SOAR container
      - DEMO_MODE=false              # Disables fake traffic
      - ENABLE_COLLECTORS=true
      - JWT_SECRET_KEY=change_this_to_a_secure_random_string
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - kafka
      - opensearch
      - soar
    networks:
      - nexdefend-net

  # --- 2. AI Microservice ---
  ai:
    image: nexdefend/core:v1.0.0
    container_name: nexdefend-ai
    restart: always
    # OVERRIDE: Run only the Python API
    command: gunicorn --bind 0.0.0.0:5000 --chdir /app/nexdefend-ai api:app
    environment:
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_USER=nexdefend
      - DB_PASSWORD=secure_password
      - DB_NAME=nexdefend
    networks:
      - nexdefend-net

  # --- 3. SOAR Engine (Remediation) ---
  soar:
    image: nexdefend/core:v1.0.0
    container_name: nexdefend-soar
    restart: always
    command: /nexdefend-soar-bin
    cap_add:
      - NET_ADMIN  # Required for iptables
    environment:
      - DB_TYPE=postgres
      - DB_HOST=postgres
      - DB_USER=nexdefend
      - DB_PASSWORD=secure_password
      - DB_NAME=nexdefend
      - DEMO_MODE=false
    networks:
      - nexdefend-net

  # --- 4. Enterprise Database (PostgreSQL) ---
  postgres:
    image: postgres:15-alpine
    container_name: nexdefend-postgres
    restart: always
    environment:
      POSTGRES_USER: nexdefend
      POSTGRES_PASSWORD: secure_password
      POSTGRES_DB: nexdefend
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - nexdefend-net

  # --- 5. Message Broker (Kafka) ---
  kafka:
    image: bitnami/kafka:latest
    container_name: nexdefend-kafka
    restart: always
    environment:
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - nexdefend-net

  # --- 6. Search Engine (OpenSearch) ---
  opensearch:
    image: opensearchproject/opensearch:latest
    container_name: nexdefend-opensearch
    restart: always
    environment:
      - discovery.type=single-node
      - plugins.security.disabled=true # Simplified for offline/local
    volumes:
      - opensearch_data:/usr/share/opensearch/data
    networks:
      - nexdefend-net

  # --- 7. Frontend ---
  ui:
    container_name: ui
    build:
      context: ui
      dockerfile: Dockerfile.prod
    ports:
      - "80:80"
    depends_on:
      - api
    networks:
      - nexdefend-net

networks:
  nexdefend-net:
    driver: bridge

volumes:
  postgres_data:
  kafka_data:
  opensearch_data:
